<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oy Ver</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #join-screen,
        #vote-screen {
            width: 100%;
        }

        #vote-screen {
            display: none;
        }

        .code-display {
            font-size: 1rem;
            color: #a5b4fc;
            letter-spacing: 4px;
            text-align: center;
            margin-bottom: 1rem;
        }

        input {
            text-align: center;
            font-size: 1.6rem;
            letter-spacing: 8px;
            font-weight: 900;
        }

        .error {
            color: #f87171;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
        }

        /* Gökkuşağı Efekti - style.css çakışmalarını tamamen ezmek için */
        #join-screen h1#wave-text {
            all: unset;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            font-family: 'Inter', sans-serif !important;
            font-size: 4rem !important;
            font-weight: 900 !important;
            margin-bottom: 3rem !important;
            perspective: 1000px !important;
            cursor: default !important;
            padding: 40px 0 !important;
            text-align: center !important;
            width: 100% !important;
        }

        .letter {
            display: inline-block !important;
            /* Akıcı Gökkuşağı - Sub-properties kullanıyoruz ki animasyon çalışabilsin */
            background-image: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000) !important;
            background-size: 800px 100% !important;
            background-repeat: repeat !important;
            background-position: 0 0;
            /* !important OLMAMALI */

            -webkit-background-clip: text !important;
            background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            color: transparent !important;

            animation: move_gradient 3s linear infinite !important;
            transition: transform 0.1s ease-out !important;
            pointer-events: none !important;
            white-space: pre !important;
            will-change: transform !important;
            font-weight: 900 !important;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.1)) !important;
        }

        @keyframes move_gradient {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 800px 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="join-screen">
            <h1 id="wave-text">Ankete Katıl</h1>
            <input type="text" id="code-input" placeholder="0000" maxlength="4" inputmode="numeric"
                oninput="this.value=this.value.replace(/\D/g,'')">
            <button onclick="joinPoll()">Katıl</button>
            <p class="error" id="error-msg">Geçersiz anket kodu. Lütfen tekrar deneyin.</p>
        </div>

        <div id="vote-screen">
            <div class="code-display" id="poll-code-label"></div>
            <h1 id="question">Yükleniyor...</h1>
            <div id="optionsGroup"></div>
        </div>
    </div>

    <script>
        (function initUI() {
            const waveText = document.getElementById('wave-text');
            if (!waveText) return;

            const text = "Ankete Katıl";
            waveText.innerHTML = "";

            text.split('').forEach((char, i) => {
                const span = document.createElement('span');
                span.className = 'letter';
                span.textContent = char;
                // Senkronize bir akış için her harfe negatif gecikme veriyoruz
                span.style.animationDelay = `${i * -0.15}s`;
                waveText.appendChild(span);
            });

            const letters = document.querySelectorAll('.letter');

            document.addEventListener('mousemove', (e) => {
                const mouseX = e.clientX;
                const mouseY = e.clientY;

                letters.forEach((span) => {
                    const rect = span.getBoundingClientRect();
                    const charX = rect.left + rect.width / 2;
                    const charY = rect.top + rect.height / 2;

                    const diffX = mouseX - charX;
                    const diffY = mouseY - charY;
                    const dist = Math.sqrt(diffX * diffX + diffY * diffY);

                    const maxDist = 300;
                    if (dist < maxDist) {
                        const force = (maxDist - dist) / maxDist;
                        const moveX = diffX * force * 0.6;
                        const moveY = diffY * force * 0.6;
                        const rotate = moveX * 0.2;
                        const scale = 1 + (force * 0.4);
                        span.style.transform = `translate(${moveX}px, ${moveY}px) rotate(${rotate}deg) scale(${scale})`;
                    } else {
                        span.style.transform = `translate(0, 0) rotate(0deg) scale(1)`;
                    }
                });
            });
        })();

        let socket;
        try {
            if (typeof io !== 'undefined') {
                socket = io();
                setupSocketHandlers();
            }
        } catch (e) { console.error(e); }

        let currentCode = null;

        function joinPoll() {
            const code = document.getElementById('code-input').value.trim();
            if (code.length !== 4) return;
            currentCode = code;
            if (localStorage.getItem(`voted_${code}`)) {
                location.href = `results.html?code=${code}`;
                return;
            }
            if (socket) socket.emit('joinPoll', code);
        }

        document.getElementById('code-input').addEventListener('keydown', e => {
            if (e.key === 'Enter') joinPoll();
        });

        const urlParams = new URLSearchParams(location.search);
        const urlCode = urlParams.get('code');
        if (urlCode) {
            document.getElementById('code-input').value = urlCode;
            setTimeout(joinPoll, 500);
        }

        function setupSocketHandlers() {
            socket.on('init', (data) => {
                document.getElementById('error-msg').style.display = 'none';
                document.getElementById('join-screen').style.display = 'none';
                document.getElementById('vote-screen').style.display = 'block';
                document.getElementById('poll-code-label').innerText = `KOD: ${data.code}`;
                document.getElementById('question').innerText = data.question;

                const group = document.getElementById('optionsGroup');
                group.innerHTML = '';
                data.options.forEach((opt, i) => {
                    const b = document.createElement('button');
                    b.innerText = opt;
                    b.onclick = () => {
                        socket.emit('castVote', { code: currentCode, index: i });
                        localStorage.setItem(`voted_${currentCode}`, '1');
                        location.href = `results.html?code=${currentCode}`;
                    };
                    group.appendChild(b);
                });
            });

            socket.on('pollError', (msg) => {
                const el = document.getElementById('error-msg');
                el.innerText = msg;
                el.style.display = 'block';
            });
        }
    </script>
</body>

</html>